<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Attention restoration experiment, with Adaptive DSB and Visual Search</title>
  <!--  Load jsPsych CSS -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
     body {
            background-color: #808070;
        }
    /* Custom styles for better visibility and responsiveness */
    .progress-container {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      z-index: 1000;
    }

    .progress-bar {
      height: 100%;
      background-color: #4CAF50;
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    .experiment-text {
      color: white;
      font-size: 24 px;
      /* adjust as needed, or update with pixelsperUnit*/
      text-align: center;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .experiment-images {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            /* uses viewport height or width */
            background-color: #808070;
    }
    .search-target {
      font-weight: bold;
      text-shadow: 0 0 3px white;
    }
    .standard-button {
      font-size: 20px;
      padding: 15px 30px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
    @media (max-width: 768px) {
      .search-item {
        font-size: 4vw !important;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .search-item {
        font-size: 3vw !important;
      }
    }

    @media (min-width: 1025px) {
      .search-item {
        font-size: 2vw !important;
      }
    }
  </style>
<!-- add to work with JATOS -->
<script src="jatos.js"></script>
</head>

<body>
  <!-- Experiment container -->
  <div id="jspsych-experiment"></div>
  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <!-- <script src= "https://unpkg.com/jspsych@7.3.3/dist/index.browser.min.js"></script> -->
  <!-- Load the html-keyboard-response plugin -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <!-- Load the html-button-response plugin -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-resize@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>

  

  <script>

    //Initialize JsPsych    
    const jsPsych = initJsPsych({
        display_element: 'jspsych-experiment',
        on_finish: function () {
          console.log("Experiment finished!");
          //retrieve data
          const data = jsPsych.data.get();
          // Generate CSV and JSON data
          const csvData = data.csv();
          // Added JSON data for JATOS GUI
          const jsonData = data.json();

          // if not in jatos, show the result on screen.
          if (typeof jatos === 'undefined') {
            //dev mode, local, (prob running in macbook/offline), show data on screen.
            jsPsych.data.displayData(csvData);
          } else { // upload to jatos and redirect afterwards.

            //create and upload csv blob first:
            const csvBlob = new Blob([csvData], { type: 'text/csv' });
            jatos.uploadResultFile(csvBlob, "experiment-data.csv", function () {
              console.log("File upload successful");
              // Submit JSON data using callback approach
              console.log("Submitting JSON data to JATOS...");

              jatos.submitResultData(jsonData, function () {
                console.log("JSON data submitted successfully");
                // Get participant ID from URL (with defensive checks)
                var pp_id = "DEFAULT_ID";
                if (jatos.urlQueryParameters && jatos.urlQueryParameters.SONA_ID) {
                  pp_id = jatos.urlQueryParameters.SONA_ID;
                  debugLog(`SONA ID is ${pp_id}`);
                } else {
                  debugLog(`SONA ID not found, using default`);
                }
                // Create completion URL for receiving credit
                var completion_url = "https://uts-psych.sona-systems.com/webstudy_credit.aspx?experiment_id=93&credit_token=2e1c89bde83e447b8a413df54c340722&survey_code=" + pp_id;
                if (pp_id === "DEFAULT_ID") {
                  completion_url = "http://127.0.0.1:9000/jatos/4/11/results";
                }
                // Only redirect after both file upload AND data submission
                jatos.endStudyAndRedirect(completion_url);
              },
              );
            }
            );
          }
        }
      });
      
    // a better function for debugging: shorthand for console.log()
    function debugLog(message) {
      console.log(`[${new Date().toISOString()}] ${message}`);
    }
    
    let pixelsPerUnit= 150;// default to start with
    
    // Set static and global experiment parameters
    let experimentParams = {
      // Block structure
      nBlocks: 1,
      nTrials: 1,
      nPracticeTrials: 1, // this n is per type (there are 4 reps of DSB and vis Search within each)

      // Visual search parameters
      searchDifficulty: 1, //[1 or 2], easy or hard, updated dynamically below.      
      minDistancePercentage: 1, // min dist between elements.
      containerPaddingPercentage: 5, // reduced to avoid stack overflow.
      nTargs: 30,
      searchTrialDuration: 2500, // ms per search. 
      nRepeats: 10, // how many reps per sequence?

      // DSB parameters
      minDigitSpan: 4,
      maxDigitSpan: 8,
      digitDuration: 1000, //ms

      // Image parameters
      nImages: 3,
      imgDuration: 15000, //ms 

      // Attention check parameters
      attentionCheckFrequency: 0.1, // 10% chance per trial

      // also add some dynamic fields which we will update and save from
      dyn_trialidx:0, //count in exp
      dyn_trial:0, //count in block
      dyn_block:0, //
      dyn_VSD: 1, // visual search difficulty
      dyn_VS_propcorrect: 0, //proportion of vis search targets found. 
      dyn_VS_meanRT: 0,//visual search mean RT
      dyn_DSBpre_propcorrect: 0, //the  proportion of sequences correct.
      dyn_DSBpre_digitaccuracy: 0,//the number of digits correct.
      dyn_DSBpre_maxspan: 0, // the max span correct.
      dyn_imageID: 0, // image index/identifier.
      dyn_DSBpost_propcorrect: 0, //the  proportion of sequences correct.      
      dyn_DSBpost_digitaccuracy: 0, // the max span correct. 
      dyn_DSBpost_maxspan: 0,//the number of digits correct.

    };

    // Message Components
    const messages = {
      Welcome: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="experiment-text" style= "font-size: ${24 * pixelsPerUnit / 150}px;">
          Welcome !! <br><br>
          On the next screen you will be shown the Participant Information Sheet and Consent Form. <br><br> Please
          read both carefully before confirming your participation.</div>`,
        choices: ["continue"],
        button_html: '<button class="standard-button">%choice%</button>',        
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `welcome_msg`;
          data.task ='wecome';
        }
      },
      
      PISdoc: {
        type: jsPsychHtmlButtonResponse,
        stimulus: function () {
          return `
          <div style="display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0;">
          <div style="width: 100vh; height: 80vh; border: 1px solid #ccc; background-color: white; margin: 40 auto; overflow: hidden;">
          <iframe src="docs/PIS.pdf#view=FitH" style="width: 100%; height: 90%; border: none;"></iframe>
          </div>
          </div>
          `;
        },
        choices: [`Click here to confirm consent and continue. Or close this browser window to end the study.`],
        button_html: '<button class="standard-button">%choice%</button>',
        
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `PISdoc`;
          data.task= 'PIS';
        }

      },
      Debriefdoc: {
        type: jsPsychHtmlButtonResponse,
        stimulus: function () {
          return `            
            <div style="display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0;">
                <div style="width: 100vh; height: 80vh; border: 1px solid #ccc; background-color: white; margin: 40 auto; overflow: hidden;">
                    <iframe src="docs/debrief.pdf#view=FitH" style="width: 100%; height: 90%; border: none;"></iframe>
                </div>                        
            </div>
          `;
        },
        choices: [`Click here to end the experiment and receive course credit.`],
        button_html: '<button class="standard-button">%choice%</button>',
        
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `debrief`;
          data.task= 'debrief' ;
        }

      },
      pracInstructions: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div style= "font-size: ${24 * pixelsPerUnit / 150}px; color: white; 
        position: absolute;
         top: 50%;left: 50%; transform: translate(-50%, -50%)">        

            <br>Welcome to the experiment.<br> 
            Please read the instructions carefully.<br>
            There are two task types.<br><br>
            In the visual search task:<br>
            You must search the screen for either a red <font color = "red">"T" </font>
            or blue <font color = "blue"> "O" </font> hidden among red <font color = "red"> "X"s </font>.
            <br><br> In the digit task:<br> You must recall a list of numbers in reverse order. </div>
        `,
        choices: ["Let's practice!"],
        button_html:  '<button class="standard-button">%choice%</button>',
      },
      expInstructions: {
        timeline: [
          {
            type: jsPsychHtmlButtonResponse,
            stimulus: function () {
              const slideNumber = jsPsych.timelineVariable('slideNum');
              return `
                        <div class = "experiment-images">                      
                    <img src="instruction-images/expInstructions/Slide${slideNumber}.jpeg" 
                    alt="Experiment Instructions" > 
                    </div>`;
            },
            choices: ["Continue"],
            button_html: '<button class="standard-button">%choice%</button>',
            
            on_finish: function (data) {
              //replace stim with simple placeholder
              data.stimulus = `expInstruc`;
              data.task = `expIntructions`;

            }
          }
        ],
        timeline_variables: [
          { slideNum: 1 },
          { slideNum: 2 },
          { slideNum: 3 },
          { slideNum: 4 },
          { slideNum: 5 },
          { slideNum: 6 },
          { slideNum: 7 }
        ]
      },

      startMain: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="experiment-text" style= "font-size: ${24 * pixelsPerUnit / 150}px;">
          You are now ready to start the main experiment </div>`,
        choices: ['Continue'],
        button_html:  '<button class="standard-button">%choice%</button>',
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `startMain`;
          data.task = `startMain`;
        } 
      },
      getReady: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="experiment-text" style= "font-size: ${24 * pixelsPerUnit / 150}px;">
          Get ready for the next trial </div>`,
        choices: ['Continue'],
        button_html:  '<button class="standard-button">%choice%</button>',
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `getReady`;
          data.task = `getReady`;
        } 
      },

      VisSearchInstructions: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style = "font-size: ${24 * pixelsPerUnit / 150}px; color: white; 
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);">
           On the next screen, you must search for either a red</span> 
            <span style="color: red;">"T"</span> or blue <span style="color: blue;">"O"</span><br>
             hidden among red <span style="color: red;">"X"</span>s. </div>
        `,
        choices: ['Ready'],
        button_html:  '<button class="standard-button">%choice%</button>',
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `VS_instruct`;
          data.task = `VS_instruct`;
        } 
      },

      DSBinstructions: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div style= "font-size: ${24 * pixelsPerUnit / 150}px; color: white; 
        position: absolute;
         top: 50%;left: 50%; transform: translate(-50%, -50%)"> 
            <br><br>On the next screen, you will be shown a sequence of numbers.<br><br>
            <br><br>
            Your task is to remember the numbers in reverse order.<br>
            e.g. if you see <span style="color: blue;">1, 2, 3, 4</span>,<br>
            respond: <span style="color: red;">4, 3, 2, 1<br><br><br><br></span>
          </div>
        `,
        choices: ['Ready'],
        button_html:  '<button class="standard-button">%choice%</button>',
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `DSB_instruct`;
          data.task = `DSB_instruct`;
        } 
      },
      imageInstructions: {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="experiment-text" style= "font-size: ${24 * pixelsPerUnit / 150}px;">
            <br><br>On the next screen, you will be shown an image of nature.<br><br>
            Please view this image, the experiment will resume shortly.
          </div>
        `,
        choices: ['Ready'],
        button_html:  '<button class="standard-button">%choice%</button>',
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `image_instruct`;
          data.task = `image_instruct`;
        } 
      },

    };


    const feedbackTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        const lastRecall = jsPsych.data.get().last(1).values()[0];
        return lastRecall.is_correct
          ? "<p style='color:green;'>Correct!</p><p>Good job!</p>"
          : "<p style='color:red;'>Incorrect.</p><p>Try to recall in the reversed order.</p>";
      },
      choices: ['Continue'],
      on_finish: function (data) {
          //replace stim with simple placeholder          
          data.task = `feedback`;
        } 
    };

    // survey variable 
    
    const PRSpreamble={
      type: jsPsychHtmlButtonResponse,
      stimulus: ` <div class = "experiment-text"; style= "font-size: ${24 * pixelsPerUnit / 150}px;">
      We are intereted in how you experience this environment. <br>
      To help us understand your experience, we have provbided the following statements for you to respond to.<br> 
      Please read carefully, then ask yourself: 
      "how much does this statement apply to my experience here?". <br>
      To indicate your answer choose one number from the rating scale beside the statement.
      So, for example, if you think the statement does not apply to you at all, choose "0" (not at all).
      If you think it applies rather much, then select "6" rather much. If you think that it applies very much, you would select "10" (very much).
      0 -1- 2- 3- 4- 5- 6</div>`,
      choices: ['Continue'],
      button_html: '<button class="standard-button">%choice%</button>',
      on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `PRS_preamble`;
          data.task = `PRS_preamble`;
        } 
    };

    //this function creates the labels used below
    function createLabelSet() {
        const labels = [];

        // Add the "0(not at all)" label
        labels.push("<div style='color:white; text-align:center;'>0<br>(not at all)</div>");

        // Add labels 1-4
        for (let i = 1; i <= 4; i++) {
          labels.push(`<div style='color:white; text-align:center;'>${i}</div>`);
        }

        // Add the "5(moderate agreement)" label
        labels.push("<div style='color:white; text-align:center;'>5<br>(moderate agreement)</div>");

        // Add labels 6-9
        for (let i = 6; i <= 9; i++) {
          labels.push(`<div style='color:white; text-align:center;'>${i}</div>`);
        }

        // Add the "10(complete agreement)" label
        labels.push("<div style='color:white; text-align:center;'>10<br>(complete agreement)</div>");

        return labels;
      }
    
    function createPRS11(imgNumber) {
      return {
        type: jsPsychSurveyLikert,
        preamble: `<div style="text-align: center; margin-bottom: 30px;">
          <img src="images/photo_${imgNumber}.jpg" style="max-width: 80%; max-height: 50vh; border-radius: 10px; box-shadow: 0 0 10px rgba(255,255,255,0.2);">
          <div style="color: white; font-size: ${24 * pixelsPerUnit / 150}px;">
          <p>Please rate how much each statement applies to your experience of this image:</p>
          </div>
          </div>`,
        questions: [
          { prompt: "Places like that are fascinating", name: 'FA_12', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "In places like this my attention is drawn to many interesting things", name: 'FA_7', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "In places like this it is hard to be bored", name: 'FA_11', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "Places like this are a refuge from nuisances", name: 'BA_1', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "To get away from things that usually demand my attention I like to go to places like this", name: 'BA_5', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "To stop thinking about the things that I must get done I like to go to places like this", name: 'BA_4', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "There is a clear order in the physical arrangement of places like this", name: 'COH_15rev', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "In places like this it is easier to see how things are organised", name: 'COH_26', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "In places like this everything seems to have its proper place", name: 'newitem', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "That place is large enough to allow exploration in many directions", name: 'FA_10', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
          { prompt: "In places like that there are few boundaries to limit my possibility for moving about", name: 'X', labels: ["0<br>(not at all)", "1", "2", "3", "4", "5<br>(moderate agreement)", "6", "7", "8", "9", "10<br>(complete agreement)"] },
        ],
        randomize_question_order: false,
        scale_width: 500,
        button_label: 'Continue',
        data: {
          task: 'PRS-11'          
        },
        // Add custom styling for white text
        on_load: function () {
          // Make all text elements white for dark background
          document.querySelectorAll('.jspsych-survey-likert-statement').forEach(element => {
            element.style.color = 'white';
          });
          // Add CSS to make the survey labels white and centered
          const styleElement = document.createElement('style');
          styleElement.textContent = `
          .jspsych-survey-likert-opt-label {
            color: white !important;
            text-align: center !important;
          }
        `;
          document.head.appendChild(styleElement);
        },
        on_finish: function (data) {
          //replace stim with simple placeholder
          data.stimulus = `PRS11`;          
        } 
      };
    }


    // Preload images
    const preloadImages = {
      type: jsPsychPreload,
      images: Array.from({ length: experimentParams.nImages }, (_, i) => `images/photo_${i + 1}.jpg`),
      message: 'Loading experiment resources...',
      show_progress_bar: true,
      continue_after_error: true,
      error_message: 'Failed to load some images. The experiment will continue, but you may experience some delays.',
      on_error: function (file) {
        console.error(`Failed to load: ${file}`);
      }
    };


    // Attention check trial
    function createAttentionCheck() {
      return {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style="text-align: center;">
            <p>Attention Check: Please select the button labeled "Continue"</p>
          </div>
        `,
        choices: ['Stop', 'Continue', 'Next'],
        on_finish: function (data) {
          data.is_attention_check = true;
          data.attention_check_correct = data.response === 1;
          data.stimulus = 'attncheck';
          data.task = 'attncheck'
        }
      };
    }



    function callSingleImageTrial(imgID) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <img src="images/photo_${imgID}.jpg" 
              style="width: 100vw; height: 100vh; object-fit: cover; border-radius: 30px; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);">
        </div>`,

        choices: "NO_KEYS", // No response required
        trial_duration: experimentParams.imgDuration, // Hold 
        on_load: () => {
          console.log("Static scene loaded.");
        },
        on_finish: function (data) {
          data.stimulus = `img${imgID}`;        
          data.task = `img${imgID}`;
        }
        
      }
    }

    function generateGridPositions(n, containerWidth, containerHeight, containerPaddingPercentage) {
      const positions = [];

      // Calculate padding in pixels
      const padding = Math.min(containerWidth, containerHeight) * (containerPaddingPercentage / 100);
      // Define grid size
      const gridSize = Math.ceil(Math.sqrt(n)); // Number of rows and columns in the grid
      const cellWidth = (containerWidth - 2 * padding) / gridSize;
      const cellHeight = (containerHeight - 2 * padding) / gridSize;

      // Generate all possible grid cells
      const gridCells = [];
      for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
          gridCells.push({ row, col });
        }
      }

      // Shuffle the grid cells to randomize their order
      for (let i = gridCells.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [gridCells[i], gridCells[j]] = [gridCells[j], gridCells[i]];
      }

      // Select the first `n` grid cells
      for (let i = 0; i < n; i++) {
        const cell = gridCells[i];

        // Calculate center of cells
        const x = padding + (cell.col + 0.5) * cellWidth; // Center of the cell
        const y = padding + (cell.row + 0.5) * cellHeight; // Center of the cell

        // Add jitter (small offsets)
        const jitterX = (Math.random() - 0.5) * cellWidth * 0.8; // ±40% of cell
        const jitterY = (Math.random() - 0.5) * cellHeight * 0.8; // ±40% of cell

        // Convert to percentages
        const xPercent = ((x + jitterX) / containerWidth) * 100;
        const yPercent = ((y + jitterY) / containerHeight) * 100;

        positions.push({ x: xPercent, y: yPercent });
      }

      return positions;
    }

function createVisualSearchTrial(searchDifficulty) {
    const itemSize = pixelsPerUnit* 0.5; // Adjusts to relevant size
    // debugger;
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        const positions = generateGridPositions(
          experimentParams.nTargs + 1,
          window.innerWidth*0.8 ,
          window.innerHeight*0.8,          
          experimentParams.containerPaddingPercentage
        );
        debugLog( "generatedpositions:", positions )
        let stimulusHTML = `<div style="width: 90vw; height: 90vh; background-color: #f0f0f0; position: relative; margin: auto; border-radius: 10px;">`;

        for (let i = 0; i < experimentParams.nTargs; i++) {
          const pos = positions[i];
          const rotation = Math.random() * 360;
          stimulusHTML += `<div class="search-item responsive" style="position: absolute; top: ${pos.y}%; left: ${pos.x}%; width: ${itemSize}px; height: ${itemSize}px; color: red; text-shadow: 0 0 3px white; font-weight: bold; transform: rotate(${rotation}deg);">X</div>`;
        }

        const targetPos = positions[experimentParams.nTargs];
        const targetRotation = Math.random() * 360;
        const targetColor = searchDifficulty === 1 ? 'blue' : 'red';
        const targetShape = searchDifficulty === 1 ? 'O' : 'T';

        stimulusHTML += `<div id="target" class="search-item search-target responsive" style="position: absolute; top: ${targetPos.y}%; left: ${targetPos.x}%; width: ${itemSize}px; height: ${itemSize}px; color: ${targetColor}; text-shadow: 0 0 3px white; font-weight: bold; cursor: pointer; transform: rotate(${targetRotation}deg);">${targetShape}</div>`;

        stimulusHTML += '</div>';
        return stimulusHTML;
      },
      choices: [],
      on_load: () => {
        const progressBar = document.createElement('div');
        progressBar.id = 'trial-progress-bar';
        progressBar.style.cssText = `
          position: absolute;
          bottom: 5vh;
          left: 10vw;
          width: 80vw;
          height: 20px;
          background-color: #ddd;
          border-radius: 10px;
          overflow: hidden;
        `;

        progressBar.innerHTML = `
          <div id="trial-progress-fill" 
              style="width: 100%; height: 100%; background-color: #4CAF50; transition: width 0.05s linear;">
          </div>`;
        document.body.appendChild(progressBar);

        const startTime = performance.now();
        const progressInterval = setInterval(() => {
          const elapsedTime = performance.now() - startTime;
          const remainingTime = Math.max(0, experimentParams.searchTrialDuration - elapsedTime);
          const progressPercent = (remainingTime / experimentParams.searchTrialDuration) * 100;
          document.getElementById('trial-progress-fill').style.width = `${progressPercent}%`;

          if (remainingTime <= 0) {
            clearInterval(progressInterval);
            document.body.removeChild(progressBar);
            jsPsych.finishTrial({ rt: null, correct: false });
          }
        }, 50);

        document.getElementById('target').addEventListener('click', () => {
          clearInterval(progressInterval);
          document.body.removeChild(progressBar);
          jsPsych.finishTrial({ rt: performance.now() - startTime, correct: true });
        });
      },
      on_finish: (data) => {        
        data.search_difficulty = searchDifficulty;
        data.enhanced = true;
        data.stimulus='VisSearch';
        data.task='VisSearch';

        if (!data.rt) {
          console.log('Timeout: No response.');
        } else if (!data.correct) {
          console.log('Incorrect response.');
        } else {
          console.log('Correct response in', data.rt, 'ms.');
        }
      },
    };
  }//end function

    // Modified digitSpanBackwardTask with dynamic length
    function createDigitSpanTask(currentSpan) {
      let digitsforCurrentTrial=[];
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        on_load: () => {
          const stimulusDiv = document.createElement('div');
          stimulusDiv.id = 'digit-span-stimulus';
          stimulusDiv.style.position = 'absolute';
          stimulusDiv.style.top = '50%';
          stimulusDiv.style.left = '50%';
          stimulusDiv.style.transform = 'translate(-50%, -50%)';
          stimulusDiv.style.fontSize = '15vw';
          stimulusDiv.style.fontWeight = 'bold';
          stimulusDiv.style.textAlign = 'center';
          document.body.appendChild(stimulusDiv);

          // Generate random sequence of digits
          digitsforCurrentTrial=[];
          for (let i = 0; i < currentSpan; i++) {
            digitsforCurrentTrial.push(Math.floor(Math.random() * 10));
          }
          
          console.log('current digits:', digitsforCurrentTrial);

          let currentDigitIndex = 0;
          let timeoutId; // store the timeoutID for cleanup

          const showNextDigit = () => {
            stimulusDiv.innerHTML = '-';
            timeoutID = setTimeout(() => {
              if (currentDigitIndex < digitsforCurrentTrial.length) {
                stimulusDiv.innerHTML = digitsforCurrentTrial[currentDigitIndex];
                currentDigitIndex++;
                timeoutID = setTimeout(showNextDigit, experimentParams.digitDuration); //schedule next digit
              } else {
                stimulusDiv.innerHTML = '';
                cleanup(); //cleanup and finish trial
                jsPsych.finishTrial({
                  originalDigits: digitsforCurrentTrial,
                  currentSpanLength: currentSpan,
                });
              }
            }, 100);
          };
          const cleanup = () => {
            //clear any pending timeouts
            if (timeoutId) {
              clearTimeout(timeoutId);
            }
            //Remove the stimulus div from the DOM
            if (stimulusDiv && stimulusDiv.parentNode) {
              stimulusDiv.parentNode.removeChild(stimulusDiv);
            }
          }

          showNextDigit(); //start showing digits.
        },
        choices: [],
        on_finish: (data) => {
          if (data.originalDigits){
            // Create a copy of the array before reversing (to avoid mutating the original)
            const reversedDigits = [...data.originalDigits].reverse().join('');
            data.reversedDigits = reversedDigits;
            data.stimulus = `DSB`;
            data.task = `DSB ${data.originalDigits.join('')}`;
          } else {
            console.error('Original digits not found in trial data');
            data.reversedDigits = '';
            data.stimulus = `DSB error`;
            data.task = `DSB error`;
          }
        },

      };
    }

    function createRecallTask() {
      return {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
        <p>Please recall the digits in reverse order.</p>
        <div id="response-display" style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px;"></div>
        <div id="custom-button-container" style="text-align: center; margin-top: 20px;">
          ${[...Array(10).keys()]
            .map(
              (num) =>
                `<button class="digit-button" style="font-size: 24px; width: 40px; height: 40px; margin: 5px;" data-value="${num}">${num}</button>`
            )
            .join('')}
        </div>`,
        choices: '',
        prompt: '<p>Click the numbers in the correct order.</p>',
        data: {
          task: 'DSBrecall'          
        },
        on_load: () => {
          const lastTrial = jsPsych.data.get().last(1).values()[0];
          const reversedDigits = lastTrial.reversedDigits;
          const currentSpan = lastTrial.currentSpanLength;

          

          const userResponse = [];
          let clickedCount = 0;

          const responseDisplay = document.getElementById('response-display'); // The new display
          const buttons = document.querySelectorAll('.digit-button');

          buttons.forEach((button) => {
            button.addEventListener('click', () => {
              userResponse.push(button.dataset.value);
              clickedCount++;

              // Update response display
              responseDisplay.textContent = userResponse.join(' ');

              if (clickedCount === currentSpan) {
                const userAnswer = userResponse.join('');
                const isCorrect = userAnswer === reversedDigits;

                // also count individual digit matches: 
                let correctDigits = 0;
                const expectedDigits = reversedDigits.split('');

                // Count correct digits in the right positions
                for (let i = 0; i < userResponse.length; i++) {
                  if (userResponse[i] === expectedDigits[i]) {
                    correctDigits++;
                  }
                }
                jsPsych.finishTrial({
                  is_correct: isCorrect,
                  response: userAnswer,
                  span_length: currentSpan,
                  correct_digits: correctDigits,
                  digit_accuracy: correctDigits/currentSpan,

                });
              }
            });
          });
        },
        on_finish: function (data){
          data.stimulus= 'DSBrecall';
          
        }
      };
    }

    const customCalibration = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function () {
          return `<div style= "font-size: ${24 * pixelsPerUnit / 150}px; color: white">              
                  <p>First, Please hold a credit card up to your screen.</p>
                  <p>Adjust this box until it matches the size of the credit card.</p>
                  <div id="calibration-box" style="
                      width: 506px;
                      height: 319px;
                      border: 2px solid white;
                      background-color: rgba(255,255,255,0.2);
                      margin: 20px auto;
                      resize: both;
                      overflow: hidden;
                  "></div>
              </div>
          `;
        },
        choices: ["Continue"],
        on_load: function () {
          console.log("Custom calibration loaded");
          // Store reference to the box in window scope
          window.calibrationBox = document.getElementById('calibration-box');
          // Add event listener to the button to capture dimensions right before click
          setTimeout(function () {
            const button = document.querySelector('button.jspsych-btn');
            if (button) {
              button.addEventListener('click', function () {
                if (window.calibrationBox) {
                  window.boxWidth = window.calibrationBox.offsetWidth;
                  console.log("Box width captured before click:", window.boxWidth);
                } else {
                  console.error("Box element not found at button click");
                }
              });
            }
          }, 100);
        },

        on_finish: function (data) {
          debugLog("on finish calibration running");
          // Use the width captured by the button click
          if (window.boxWidth) {
            pixelsPerUnit = Math.round(window.boxWidth / 3.375);
            console.log("Calibration complete, pixels per unit:", pixelsPerUnit);
            data.pixels_per_unit = pixelsPerUnit;
          } else {
            console.error("Box width not captured");
            data.pixels_per_unit = 150; // Default
          }
          data.stimulus='calibration';
          data.task='calibration';
        }
      };
  
    // for help with data wrangling, create a function to consolidate data.
      
    function DSBsummarycalc(experimentParams, PreorPost) {
        // Filter recent recall data
        let recallData = jsPsych.data.get()
          .filter({ task: 'DSBrecall' })
          .last(experimentParams.maxDigitSpan - experimentParams.minDigitSpan);

        // Calculate overall performance
        let correctCount = recallData.filter({ is_correct: true }).count();
        let totalCount = recallData.count();
        let propCorrect = correctCount / totalCount;

        // Get all trials as array for easier processing
        const trials = recallData.values();

        // Find max span correct
        let maxCorrectSpan = 0;
        for (let i = 0; i < trials.length; i++) {
          if (trials[i].is_correct && trials[i].span_length > maxCorrectSpan) {
            maxCorrectSpan = trials[i].span_length;
          }
        }

        // Calculate digit-level accuracy
        let totalDigits = 0;
        let totalCorrectDigits = 0;

        // Sum up the values from all trials
        for (let i = 0; i < trials.length; i++) {
          totalDigits += trials[i].span_length;
          totalCorrectDigits += trials[i].correct_digits;
        }

        // Calculate the proportion
        const digitAccuracy = totalDigits > 0 ? totalCorrectDigits / totalDigits : 0;

        // Update dynamic fields based on PreorPost value
        if (PreorPost === 1) { // Pre-test
          experimentParams.dyn_DSBpre_propcorrect = propCorrect;
          experimentParams.dyn_DSBpre_maxspan = maxCorrectSpan;
          experimentParams.dyn_DSBpre_digitaccuracy = digitAccuracy;
        } else if (PreorPost === 2) { // Post-test
          experimentParams.dyn_DSBpost_propcorrect = propCorrect;
          experimentParams.dyn_DSBpost_maxspan = maxCorrectSpan;
          experimentParams.dyn_DSBpost_digitaccuracy = digitAccuracy;
        }

          // Log summary for debugging
          console.log(`DSB ${PreorPost === 1 ? 'Pre' : 'Post'} Performance: 
        - Proportion correct: ${(propCorrect * 100).toFixed(1)}% (${correctCount}/${totalCount})
        - Max correct span: ${maxCorrectSpan}
        - Digit accuracy: ${(digitAccuracy * 100).toFixed(1)}%`);

        // Return updated experimentParams
        return experimentParams;
      }
      // the above function needs to be within a timeline variable to collect data during runtime.
        function addDSBCalculationToTimeline(timeline, experimentParams, preOrPost) {
          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '',
            choices: "NO_KEYS",
            trial_duration: 0,
            on_finish: function (data) {
              experimentParams = DSBsummarycalc(experimentParams, preOrPost);

              // Store the values in the data
              if (preOrPost === 1) {
                data.DSBpre_propcorrect = experimentParams.dyn_DSBpre_propcorrect;
                data.DSBpre_maxspan = experimentParams.dyn_DSBpre_maxspan;
                data.DSBpre_digitaccuracy = experimentParams.dyn_DSBpre_digitaccuracy;
              } else {
                data.DSBpost_propcorrect = experimentParams.dyn_DSBpost_propcorrect;
                data.DSBpost_maxspan = experimentParams.dyn_DSBpost_maxspan;
                data.DSBpost_digitaccuracy = experimentParams.dyn_DSBpost_digitaccuracy;
              }
              data.trial_type = "dsb-summary-calculation";
            }
          });
        }

// Usage:
// addDSBCalculationToTimeline(timeline, experimentParams, 1); // For pre-test
// ... other trials ...
// addDSBCalculationToTimeline(timeline, experimentParams, 2); // For post-test


      function consolidateTrialData(experimentParams) {
          return {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '',
            choices: "NO_KEYS",
            trial_duration: 0,
            data: {
              // Pre-populate all values
              block: experimentParams.dyn_block,
              trial: experimentParams.dyn_trial,
              trialidx: experimentParams.dyn_trialidx,
              VisDifficulty: experimentParams.dyn_VSD,
              Vis_meanRT: experimentParams.dyn_VS_meanRT,
              Vis_propCorr: experimentParams.dyn_VS_propcorrect,
              DSBpre_propcorrect: experimentParams.dyn_DSBpre_propcorrect,
              DSBpre_maxspan: experimentParams.dyn_DSBpre_maxspan,
              DSBpre_digitaccuracy: experimentParams.dyn_DSBpre_digitaccuracy,
              DSBpost_propcorrect: experimentParams.dyn_DSBpost_propcorrect,
              DSBpost_maxspan: experimentParams.dyn_DSBpost_maxspan,
              DSBpost_digitaccuracy: experimentParams.dyn_DSBpost_digitaccuracy,
              imageIDX: experimentParams.dyn_imageID,              
              trial_type: "consolidated-trial-data"
            }
          };
        }
      /////////////// CREATE THE TIMELINE
      // Enhanced timeline generator (with counterbalancing?)

    
      const timeline = [];


      // Add preload
      timeline.push(preloadImages);

      timeline.push(messages.Welcome);
      timeline.push(messages.PISdoc);  
        
      //prac Instructions
      timeline.push(messages.pracInstructions);
      timeline.push(customCalibration);

      

      //add instructions for the visual search task. 
      timeline.push(messages.VisSearchInstructions);

      // practice trials have a unique structure (no images):
      // we ree[eat the vis search task, and sweep through the DSB lengths]
      
      // for (let i = 0; i < experimentParams.nPracticeTrials; i++) {
      //   // Practice visual search
      //   timeline.push(createVisualSearchTrial(1)); // 1 of 2 difficulties.
      //   timeline.push(createVisualSearchTrial(2)); // 1 of 2 difficulties.
      //   // timeline.push(createVisualSearchTrial(1)); // 1 of 2 difficulties.
      //   // timeline.push(createVisualSearchTrial(2)); // 1 of 2 difficulties.


      //   // add instructions for the DSB task
      //   timeline.push(messages.DSBinstructions);
      //   //DSB (*)min to max span)
      //   for (let iSpan = experimentParams.minDigitSpan; iSpan < experimentParams.maxDigitSpan; iSpan++) {
      //     timeline.push(messages.DSBinstructions);
      //     timeline.push(createDigitSpanTask(iSpan));
      //     timeline.push(createRecallTask());
      //     timeline.push(feedbackTrial);
      //   }
      // } 
      // now include end of practice msg
      // timeline.push(messages.expInstructions);
      
      // populate main experimental trials.
      
      let trialidx=-1; // counter
      
      for (let block = 0; block < experimentParams.nBlocks; block++) {
        for (let trial = 0; trial < experimentParams.nTrials; trial++) {
          
          trialidx=trialidx+1;
          
          // for each trial sequence (ntrials per block)

          // Randomly add attention check
          if (Math.random() < experimentParams.attentionCheckFrequency) {
            timeline.push(createAttentionCheck());
          }
          // // push message showing progress:   
          const trialStart = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<div class="experiment-text" style= "font-size: ${48 * pixelsPerUnit / 150}px;">
                    <p> Get ready to start Trial 1 of ${experimentParams.nTrials}, <br> <br>
                        Block : ${block + 1} of ${experimentParams.nBlocks} </p>`,
                choices: ['Start'],
                button_html: '<button style="font-size: 20px; padding: 15px 30px; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">%choice%</button>',
                on_finish: function (data) {
                    //replace stim with simple placeholder
                    data.stimulus = `block message`;
                }
            };

            // push block message.
            timeline.push(trialStart);

          // add trial sequence. 
          // order is currently fixed too:
          // -  vis search (easy or hard), with nRepeats
          // -  DSB, (min length 4-> max 8)
          // - image
          // - DSB recall 

          //Vis search
          // instructions:
          timeline.push(messages.VisSearchInstructions)

          // show nRepeats of fixed difficulty.
          let currentDifficulty = Math.random() < 0.5 ? 1 : 2; // 1 of 2 difficulties.)
          
          
          //push to timeline.
          for (let irep = 0; irep < experimentParams.nRepeats; irep++) {
            timeline.push(createVisualSearchTrial(currentDifficulty)); // 1 of 2 difficulties.)
          }

          //DSB (pre) sequence:
          timeline.push(messages.DSBinstructions);

          for (let iSpan = experimentParams.minDigitSpan; iSpan < experimentParams.maxDigitSpan; iSpan++) {            
            timeline.push(createDigitSpanTask(iSpan));
            timeline.push(createRecallTask());
          }
          addDSBCalculationToTimeline(timeline, experimentParams, 1); // For pre-test
          
          
          // show image.
          let im2show = Math.floor(Math.random() * experimentParams.nImages) + 1;
          timeline.push(messages.imageInstructions);
          timeline.push(callSingleImageTrial(im2show));


          //DSB (post)
          timeline.push(messages.DSBinstructions);
          for (let iSpan = experimentParams.minDigitSpan; iSpan < experimentParams.maxDigitSpan; iSpan++) {            
            timeline.push(createDigitSpanTask(iSpan));
            timeline.push(createRecallTask());
          }
          //get data for these last few trials:
          addDSBCalculationToTimeline(timeline, experimentParams, 2); // For post-test
          
          timeline.push(consolidateTrialData(experimentParams));        
          
        }

      } // for block

    // collect ratings of restorativeness per image:
    timeline.push(PRSpreamble);
      for (let imgn = 1; imgn < 4; imgn++) {
        timeline.push(createPRS11(imgn));
      }      
    timeline.push(messages.Debriefdoc); 
    jsPsych.run(timeline);//

    // jsPsych.run(generateDSBTrials(3,8));
    // initializeProgressBar(timeline)
    // or test in isolation (debug)
    // jsPsych.run([interBlockmsg(1,1)]);
    // jsPsych.run([createDigitSpanTask(currentSpan), createRecallTask()]);
    

    ////


  </script>
</body>

</html>